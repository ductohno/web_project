<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Java SQLi Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }

        .container {
            max-width: 900px;
        }

        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .vulnerable {
            border: 2px solid #dc3545;
        }

        .safe {
            border: 2px solid #198754;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="row mb-4">
            <div class="col">
                <h1 class="text-center">Java SQLi Lab</h1>
                <p class="text-center text-muted">A Vulnerable Web App for Educational Purposes</p>
                <div class="alert alert-info text-center">
                    Current Database: <strong th:text="${dbType}">SQLite</strong>
                </div>
                <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
            </div>
        </div>

        <!-- Database Switcher -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card" style="border: 2px solid #0d6efd;">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="bi bi-database"></i> Database Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Switch Database:</label>
                                <select id="dbSelector" class="form-select">
                                    <option value="sqlite">SQLite (Embedded)</option>
                                    <option value="mysql">MySQL</option>
                                    <option value="postgresql">PostgreSQL</option>
                                    <option value="mssql">Microsoft SQL Server</option>
                                    <option value="oracle">Oracle Database</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <button id="switchBtn" class="btn btn-primary w-100" onclick="switchDatabase()">
                                    <span id="switchBtnText">Switch Database</span>
                                    <span id="switchSpinner" class="spinner-border spinner-border-sm d-none"
                                        role="status"></span>
                                </button>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label fw-bold">Status:</label>
                                <div id="dbStatus" class="alert alert-info mb-0 py-2">
                                    <span id="statusText">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div id="dbMessage" class="mt-3 d-none"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats & Vulnerable Search -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card vulnerable">
                    <div class="card-header bg-danger text-white">
                        <h5><i class="bi bi-search"></i> Vulnerable Search (SQL Injection)</h5>
                    </div>
                    <div class="card-body">
                        <form action="/search" method="get" class="d-flex gap-2">
                            <input type="text" name="query" class="form-control" placeholder="Search by name..."
                                th:value="${searchQuery}">
                            <button type="submit" class="btn btn-danger">Search</button>
                        </form>
                        <div th:if="${executedSql}" class="mt-3">
                            <h6>Executed SQL:</h6>
                            <code class="d-block p-2 bg-light border rounded"
                                th:text="${executedSql}">SELECT * FROM users WHERE name LIKE '%%'</code>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Safe CRUD Operations -->
        <div class="row">
            <div class="col-md-4">
                <div class="card safe">
                    <div class="card-header bg-success text-white">
                        <h5>Add User (Safe)</h5>
                    </div>
                    <div class="card-body">
                        <form action="/add" method="post">
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <input type="text" name="name" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" name="email" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-success w-100">Add User</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>User List</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="user : ${users}">
                                    <td th:text="${user.id}">1</td>
                                    <td th:text="${user.name}">John Doe</td>
                                    <td th:text="${user.email}">john@example.com</td>
                                    <td>
                                        <!-- Edit Button Trigger Modal -->
                                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal"
                                            th:data-bs-target="'#editModal' + ${user.id}">
                                            Edit
                                        </button>
                                        <!-- Delete Form -->
                                        <form action="/delete" method="post" class="d-inline"
                                            onsubmit="return confirm('Are you sure?');">
                                            <input type="hidden" name="id" th:value="${user.id}">
                                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                        </form>

                                        <!-- Edit Modal -->
                                        <div class="modal fade" th:id="'editModal' + ${user.id}" tabindex="-1"
                                            aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Edit User</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form action="/update" method="post">
                                                            <input type="hidden" name="id" th:value="${user.id}">
                                                            <div class="mb-3">
                                                                <label class="form-label">Name</label>
                                                                <input type="text" name="name" class="form-control"
                                                                    th:value="${user.name}" required>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Email</label>
                                                                <input type="email" name="email" class="form-control"
                                                                    th:value="${user.email}" required>
                                                            </div>
                                                            <div class="d-grid">
                                                                <button type="submit" class="btn btn-primary">Save
                                                                    Changes</button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(users)}">
                                    <td colspan="4" class="text-center text-muted">No users found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load current database status on page load
        window.addEventListener('DOMContentLoaded', function () {
            loadDatabaseStatus();
        });

        // Load and display current database status
        function loadDatabaseStatus() {
            fetch('/api/current-database')
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('dbStatus');
                    const statusText = document.getElementById('statusText');

                    if (data.connected) {
                        statusDiv.className = 'alert alert-success mb-0 py-2';
                        statusText.innerHTML = `<strong>✓ Connected</strong> to ${data.type.toUpperCase()}<br><small>${data.connectionInfo}</small>`;
                    } else {
                        statusDiv.className = 'alert alert-danger mb-0 py-2';
                        statusText.innerHTML = `<strong>✗ Disconnected</strong> from ${data.type.toUpperCase()}`;
                    }

                    // Set current database in selector
                    document.getElementById('dbSelector').value = data.type.toLowerCase();
                })
                .catch(error => {
                    console.error('Error loading database status:', error);
                    document.getElementById('statusText').textContent = 'Error loading status';
                });
        }

        // Switch to selected database
        function switchDatabase() {
            const selector = document.getElementById('dbSelector');
            const newDbType = selector.value;
            const currentDbType = selector.options[selector.selectedIndex].text;

            // Confirm switch
            if (!confirm(`Switch to ${currentDbType}?\n\nNote: This will change the active database. Data is not synchronized between databases.`)) {
                return;
            }

            // Show loading state
            const switchBtn = document.getElementById('switchBtn');
            const switchBtnText = document.getElementById('switchBtnText');
            const switchSpinner = document.getElementById('switchSpinner');
            const messageDiv = document.getElementById('dbMessage');

            switchBtn.disabled = true;
            switchBtnText.textContent = 'Switching...';
            switchSpinner.classList.remove('d-none');
            messageDiv.classList.add('d-none');

            // Make API call to switch database
            fetch('/api/switch-database', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'dbType=' + encodeURIComponent(newDbType)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        messageDiv.className = 'mt-3 alert alert-success';
                        messageDiv.innerHTML = `<strong>Success!</strong> ${data.message}<br><small>Reloading page...</small>`;
                        messageDiv.classList.remove('d-none');

                        // Reload page after 1.5 seconds
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        // Show error message
                        messageDiv.className = 'mt-3 alert alert-danger';
                        messageDiv.innerHTML = `<strong>Error!</strong> ${data.message}`;
                        messageDiv.classList.remove('d-none');

                        // Reset button state
                        switchBtn.disabled = false;
                        switchBtnText.textContent = 'Switch Database';
                        switchSpinner.classList.add('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error switching database:', error);
                    messageDiv.className = 'mt-3 alert alert-danger';
                    messageDiv.innerHTML = `<strong>Error!</strong> Failed to switch database. Check console for details.`;
                    messageDiv.classList.remove('d-none');

                    // Reset button state
                    switchBtn.disabled = false;
                    switchBtnText.textContent = 'Switch Database';
                    switchSpinner.classList.add('d-none');
                });
        }

        // Optional: Load database connectivity status
        function loadDatabaseConnectivity() {
            fetch('/api/databases')
                .then(response => response.json())
                .then(data => {
                    const selector = document.getElementById('dbSelector');
                    const connectivity = data.connectivity;

                    // Update options to show connectivity status
                    Array.from(selector.options).forEach(option => {
                        const dbType = option.value;
                        const isConnected = connectivity[dbType];

                        if (isConnected) {
                            option.text = option.text.replace(' ✓', '').replace(' ✗', '') + ' ✓';
                        } else {
                            option.text = option.text.replace(' ✓', '').replace(' ✗', '') + ' ✗';
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading database connectivity:', error);
                });
        }
    </script>
</body>

</html>